<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cryptoteca | Avalanche Edition</title>
    <!-- Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #E84142;
            --primary-hover: #b32a2b;
            --bg-dark: #000000;
            --bg-card: #18181b;
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            --border: #27272a;
            --glass: rgba(24, 24, 27, 0.7);
        }

        * { box-sizing: border-box; transition: all 0.2s ease; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(232, 65, 66, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(232, 65, 66, 0.1) 0%, transparent 40%);
        }

        /* --- NAVBAR --- */
        nav {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(12px);
            padding: 1.2rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-weight: 800;
            font-size: 1.8rem;
            color: var(--text-main);
            letter-spacing: -1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo span { color: var(--primary); }

        .wallet-badge {
            background: #27272a;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.9rem;
            color: var(--primary);
            font-weight: 600;
            border: 1px solid var(--border);
            display: none;
        }

        /* --- BUTTONS --- */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            box-shadow: 0 4px 15px rgba(232, 65, 66, 0.3);
        }
        .btn:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .btn:disabled { background: #3f3f46; cursor: not-allowed; box-shadow: none; color: #71717a; }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
            box-shadow: none;
        }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }

        /* --- LAYOUT PRINCIPALE --- */
        .main-wrapper {
            display: flex;
            max-width: 1400px;
            margin: 40px auto;
            gap: 40px;
            padding: 0 20px;
        }

        /* SIDEBAR NAVIGATION */
        .sidebar {
            width: 250px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-item {
            padding: 15px 20px;
            border-radius: 12px;
            cursor: pointer;
            color: var(--text-muted);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .nav-item:hover { background: #27272a; color: white; }
        .nav-item.active { 
            background: linear-gradient(90deg, rgba(232, 65, 66, 0.1) 0%, transparent 100%);
            border-left: 3px solid var(--primary);
            color: var(--primary);
        }

        /* CONTENT AREA */
        .content { flex-grow: 1; }

        .section { display: none; animation: slideIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes slideIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }

        h2 { font-size: 2rem; margin-bottom: 5px; font-weight: 700; }
        p.subtitle { color: var(--text-muted); margin-bottom: 30px; margin-top: 0; }

        /* --- GRID & CARDS --- */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .card-img-placeholder {
            height: 160px;
            background: linear-gradient(135deg, #18181b 0%, #27272a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: rgba(255,255,255,0.05);
            position: relative;
        }
        
        .status-tag {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
        }
        .tag-active { background: #10b981; color: #064e3b; }
        .tag-removed { background: #ef4444; color: #450a0a; }

        .card-body { padding: 20px; display: flex; flex-direction: column; flex-grow: 1; }
        
        .book-title { font-size: 1.2rem; font-weight: 700; margin: 0 0 5px 0; color: white; }
        .book-author { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 15px; }
        
        .book-price { 
            font-size: 1.1rem; 
            color: var(--primary); 
            font-weight: 700; 
            margin-top: auto; 
            padding-top: 15px; 
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-actions {
            margin-top: 15px;
            display: grid;
            gap: 10px;
        }

        /* --- FORM UPLOAD --- */
        .upload-container {
            background: var(--bg-card);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid var(--border);
            max-width: 600px;
        }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem; }
        input {
            width: 100%;
            background: #09090b;
            border: 1px solid var(--border);
            padding: 14px;
            border-radius: 8px;
            color: white;
            font-family: inherit;
        }
        input:focus { outline: none; border-color: var(--primary); }

        /* --- MODAL DETTAGLI --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #18181b;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--primary);
            position: relative;
        }
        .close-modal {
            position: absolute; top: 15px; right: 20px;
            background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;
        }
        .modal-details p { border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .modal-details span { color: var(--text-muted); display: block; font-size: 0.8rem; margin-bottom: 4px;}
        .modal-details strong { font-size: 1.1rem; }

        .loader { margin: 20px auto; width: 40px; height: 40px; border: 3px solid #333; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- NAVBAR -->
    <nav>
        <div class="logo">üî∫ Cryptoteca</div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div id="walletAddress" class="wallet-badge"></div>
            <button id="connectBtn" class="btn" onclick="connectWallet()">Connetti Core Wallet</button>
        </div>
    </nav>

    <div class="main-wrapper">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="nav-item active" onclick="switchTab('catalog', this)">
                üåê Catalogo Pubblico
            </div>
            <div class="nav-item" onclick="switchTab('myRentals', this)">
                üìö I Miei Noleggi
            </div>
            <div class="nav-item" onclick="switchTab('myUploads', this)">
                üì§ I Miei Libri (Upload)
            </div>
            <div class="nav-item" onclick="switchTab('upload', this)">
                ‚ûï Carica Nuovo
            </div>
        </div>

        <!-- CONTENT -->
        <div class="content">

            <!-- SEZIONE CATALOGO -->
            <div id="catalog" class="section active">
                <h2>Catalogo Globale</h2>
                <p class="subtitle">Esplora e noleggia libri dalla blockchain Avalanche.</p>
                <div id="loaderCatalog" class="loader" style="display:none"></div>
                <div id="catalogGrid" class="grid"></div>
            </div>

            <!-- SEZIONE I MIEI NOLEGGI -->
            <div id="myRentals" class="section">
                <h2>Libreria Personale</h2>
                <p class="subtitle">I libri che hai attualmente in prestito.</p>
                <div id="loaderRentals" class="loader" style="display:none"></div>
                <div id="rentalsGrid" class="grid"></div>
            </div>

            <!-- SEZIONE I MIEI UPLOAD -->
            <div id="myUploads" class="section">
                <h2>Gestione Pubblicazioni</h2>
                <p class="subtitle">I libri che hai caricato e messo a disposizione della community.</p>
                <div id="loaderMyUploads" class="loader" style="display:none"></div>
                <div id="myUploadsGrid" class="grid"></div>
            </div>

            <!-- SEZIONE UPLOAD -->
            <div id="upload" class="section">
                <h2>Pubblica un Libro</h2>
                <p class="subtitle">Compila i dati per registrare un nuovo libro nello Smart Contract.</p>
                
                <div class="upload-container">
                    <div class="form-group">
                        <label>Titolo del Libro</label>
                        <input type="text" id="upTitle" placeholder="Inserisci il titolo">
                    </div>
                    <div class="form-group">
                        <label>Autore</label>
                        <input type="text" id="upAuthor" placeholder="Nome dell'autore">
                    </div>
                    <div class="form-group">
                        <label>IPFS Hash (CID)</label>
                        <input type="text" id="upHash" placeholder="Es. QmXoypIzjW3f...">
                        <small style="color:#555; display:block; margin-top:5px">Carica prima il file su Pinata e incolla qui il CID.</small>
                    </div>
                    <div class="form-group">
                        <label>Prezzo di Noleggio (AVAX)</label>
                        <input type="number" id="upPrice" step="0.01" placeholder="Es. 0.1">
                    </div>
                    <button class="btn" style="width: 100%; margin-top: 10px;" onclick="addBook()">Conferma e Paga Gas</button>
                    <div id="loaderUpload" class="loader" style="display:none"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- MODAL DETTAGLI -->
    <div id="detailModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <button class="close-modal" onclick="document.getElementById('detailModal').style.display='none'">&times;</button>
            <h2 id="mTitle" style="color:var(--primary); margin-top:0;">Titolo</h2>
            <div class="modal-details">
                <p><span>Autore</span> <strong id="mAuthor">Autore</strong></p>
                <p><span>ID Libro</span> <strong id="mId">#0</strong></p>
                <p><span>Prezzo Noleggio</span> <strong id="mPrice">0 AVAX</strong></p>
                <p><span>Uploader</span> <strong id="mUploader" style="font-family:monospace; font-size:0.9rem">0x...</strong></p>
                <p><span>Stato</span> <strong id="mStatus">Attivo</strong></p>
                <p><span>Hash IPFS</span> <strong id="mHash" style="word-break: break-all; font-size:0.8rem">Qm...</strong></p>
            </div>
            <div style="margin-top: 20px; display:flex; gap:10px; justify-content: flex-end;">
                 <button class="btn btn-outline" onclick="document.getElementById('detailModal').style.display='none'">Chiudi</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURAZIONE ---
        const contractAddress = "0xAa293FdA6F36Cb1d29A0ceFF9f16dFA0e397B1A5";

        const contractABI = [
            "function bookCount() view returns (uint256)",
            "function books(uint256) view returns (uint256 id, string title, string author, string ipfsHash, uint256 rentalPrice, address uploader, bool exists, bool isActive)",
            "function addBook(string title, string author, string ipfsHash, uint256 price) public",
            "function rentBook(uint256 bookId) public payable",
            "function hasAccess(address user, uint256 bookId) public view returns (bool, string)",
            "function removeBook(uint256 bookId) public"
        ];

        let provider, signer, contract, userAddress;

        // --- GESTIONE TAB UI ---
        function switchTab(tabId, element) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            if(element) element.classList.add('active');

            // Data Fetching in base alla tab
            if(tabId === 'catalog') refreshCatalog();
            if(tabId === 'myRentals') refreshRentals();
            if(tabId === 'myUploads') refreshUploads();
        }

        // --- CONNESSIONE WALLET ---
        async function connectWallet() {
            let providerSource = window.avalanche || window.ethereum;

            if (!providerSource) {
                alert("Core Wallet non trovato! Installalo da core.app");
                return;
            }

            try {
                provider = new ethers.BrowserProvider(providerSource);
                signer = await provider.getSigner();

                const network = await provider.getNetwork();
                if (network.chainId !== 43113n) {
                    try {
                        await providerSource.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xA869' }],
                        });
                        provider = new ethers.BrowserProvider(providerSource);
                        signer = await provider.getSigner();
                    } catch (e) {
                        alert("Passa alla rete Avalanche Fuji!");
                        return;
                    }
                }

                userAddress = await signer.getAddress();
                
                // Aggiorna UI Header
                document.getElementById('connectBtn').style.display = 'none';
                const badge = document.getElementById('walletAddress');
                badge.innerText = `Connected: ${userAddress.substring(0,6)}...${userAddress.substring(38)}`;
                badge.style.display = 'block';

                contract = new ethers.Contract(contractAddress, contractABI, signer);
                
                // Carica la prima tab
                refreshCatalog();

            } catch (err) {
                console.error(err);
                alert("Errore connessione: " + err.message);
            }
        }

        // --- FETCHERS DATI SEPARATI PER SEZIONE ---

        // 1. CATALOGO (Solo libri NON miei e NON noleggiati)
        async function refreshCatalog() {
            if(!contract) return;
            const grid = document.getElementById('catalogGrid');
            grid.innerHTML = '';
            document.getElementById('loaderCatalog').style.display = 'block';

            try {
                const count = await contract.bookCount();
                let found = false;

                for(let i = 1; i <= count; i++) {
                    const b = await contract.books(i);
                    if(b.exists && b.isActive) {
                        // Verifica proprietario
                        const isOwner = b.uploader.toLowerCase() === userAddress.toLowerCase();
                        // Verifica accesso (noleggio)
                        const access = await contract.hasAccess(userAddress, i);
                        const hasActiveRental = access[0];

                        // LOGICA FILTRO: Mostra solo se NON sono proprietario e NON ho noleggio attivo
                        if (!isOwner && !hasActiveRental) {
                            found = true;
                            const priceAvax = ethers.formatEther(b.rentalPrice);
                            
                            // Crea Card
                            const card = createCardHTML(b, priceAvax, 'rent');
                            grid.innerHTML += card;
                        }
                    }
                }
                if(!found) grid.innerHTML = '<p style="color:#555">Nessun libro disponibile nel catalogo.</p>';
            } catch(e) { console.error(e); }
            document.getElementById('loaderCatalog').style.display = 'none';
        }

        // 2. I MIEI NOLEGGI (Solo libri che posso leggere ma non sono miei)
        async function refreshRentals() {
            if(!contract) return;
            const grid = document.getElementById('rentalsGrid');
            grid.innerHTML = '';
            document.getElementById('loaderRentals').style.display = 'block';

            try {
                const count = await contract.bookCount();
                let found = false;

                for(let i = 1; i <= count; i++) {
                    const access = await contract.hasAccess(userAddress, i);
                    // access[0] = true se ho accesso
                    
                    if(access[0]) {
                        const b = await contract.books(i);
                        const isOwner = b.uploader.toLowerCase() === userAddress.toLowerCase();

                        // LOGICA FILTRO: Mostra solo se ho accesso E NON sono il proprietario
                        if (!isOwner) {
                            found = true;
                            // Crea Card con azione "Read"
                            const card = createCardHTML(b, ethers.formatEther(b.rentalPrice), 'read');
                            grid.innerHTML += card;
                        }
                    }
                }
                if(!found) grid.innerHTML = '<p style="color:#555">Nessun noleggio attivo.</p>';
            } catch(e) { console.error(e); }
            document.getElementById('loaderRentals').style.display = 'none';
        }

        // 3. I MIEI UPLOAD (Solo libri caricati da me)
        async function refreshUploads() {
            if(!contract) return;
            const grid = document.getElementById('myUploadsGrid');
            grid.innerHTML = '';
            document.getElementById('loaderMyUploads').style.display = 'block';

            try {
                const count = await contract.bookCount();
                let found = false;

                for(let i = 1; i <= count; i++) {
                    const b = await contract.books(i);
                    const isOwner = b.uploader.toLowerCase() === userAddress.toLowerCase();

                    // LOGICA FILTRO: Mostra solo se sono il proprietario
                    if(b.exists && isOwner) {
                        found = true;
                        // Crea Card con azione "Owner" (Read + Remove)
                        const card = createCardHTML(b, ethers.formatEther(b.rentalPrice), 'owner');
                        grid.innerHTML += card;
                    }
                }
                if(!found) grid.innerHTML = '<p style="color:#555">Non hai ancora caricato libri.</p>';
            } catch(e) { console.error(e); }
            document.getElementById('loaderMyUploads').style.display = 'none';
        }

        // --- GENERAZIONE HTML CARD ---
        function createCardHTML(book, price, type) {
            const bookData = encodeURIComponent(JSON.stringify({
                id: book.id.toString(),
                title: book.title,
                author: book.author,
                price: price,
                uploader: book.uploader,
                isActive: book.isActive,
                hash: book.ipfsHash
            }));

            let actionBtn = '';
            let statusBadge = book.isActive 
                ? '<span class="status-tag tag-active">Disponibile</span>' 
                : '<span class="status-tag tag-removed">Rimosso</span>';

            if(type === 'rent') {
                actionBtn = `<button class="btn" style="width:100%" onclick="rentBook(${book.id}, '${price}')">Noleggia</button>`;
            } else if (type === 'read') {
                statusBadge = '<span class="status-tag tag-active" style="background:var(--primary); color:white">Noleggiato</span>';
                actionBtn = `<button class="btn btn-outline" style="width:100%" onclick="window.open('https://dweb.link/ipfs/${book.ipfsHash}', '_blank')">üìñ Leggi Ora</button>`;
            } else if (type === 'owner') {
                const removeBtn = book.isActive 
                    ? `<button class="btn" style="background:#ef4444; flex:1" onclick="removeBook(${book.id})">Rimuovi</button>` 
                    : `<button class="btn" disabled style="flex:1">Rimosso</button>`;
                
                const readBtn = `<button class="btn btn-outline" style="flex:1" onclick="window.open('https://dweb.link/ipfs/${book.ipfsHash}', '_blank')">Leggi</button>`;
                
                actionBtn = `<div style="display:flex; gap:10px">${readBtn}${removeBtn}</div>`;
            }

            return `
            <div class="card" onclick="openModal('${bookData}', event)">
                ${statusBadge}
                <div class="card-img-placeholder">üìï</div>
                <div class="card-body">
                    <h3 class="book-title">${book.title}</h3>
                    <div class="book-author">${book.author}</div>
                    <div class="book-price">
                        <span>Prezzo:</span>
                        <span>${price} AVAX</span>
                    </div>
                    <div class="card-actions" onclick="event.stopPropagation()">
                        ${actionBtn}
                    </div>
                </div>
            </div>
            `;
        }

        // --- GESTIONE MODALE ---
        function openModal(bookDataEncoded, event) {
            // Evita che il modale si apra se clicco sui bottoni
            if(event.target.tagName === 'BUTTON') return;

            const data = JSON.parse(decodeURIComponent(bookDataEncoded));
            
            document.getElementById('mTitle').innerText = data.title;
            document.getElementById('mAuthor').innerText = data.author;
            document.getElementById('mId').innerText = "#" + data.id;
            document.getElementById('mPrice').innerText = data.price + " AVAX";
            document.getElementById('mUploader').innerText = data.uploader;
            document.getElementById('mStatus').innerText = data.isActive ? "Attivo / Noleggiabile" : "Rimosso dal mercato";
            document.getElementById('mStatus').style.color = data.isActive ? "#10b981" : "#ef4444";
            document.getElementById('mHash').innerText = data.hash;

            document.getElementById('detailModal').style.display = 'flex';
        }

        function closeModal(event) {
            if(event.target.id === 'detailModal') {
                document.getElementById('detailModal').style.display = 'none';
            }
        }

        // --- AZIONI BLOCKCHAIN  ---
        async function addBook() {
            const title = document.getElementById('upTitle').value;
            const author = document.getElementById('upAuthor').value;
            const hash = document.getElementById('upHash').value;
            const price = document.getElementById('upPrice').value;

            if(!title || !hash || !price) return alert("Compila tutti i campi");

            try {
                document.getElementById('loaderUpload').style.display = 'block';
                const tx = await contract.addBook(title, author, hash, ethers.parseEther(price));
                await tx.wait();
                alert("Libro pubblicato!");
                document.getElementById('upTitle').value = '';
                document.getElementById('upHash').value = '';
                switchTab('myUploads', document.querySelectorAll('.nav-item')[2]);
            } catch(e) { 
                alert("Errore: " + e.message); 
            }
            document.getElementById('loaderUpload').style.display = 'none';
        }

        async function rentBook(id, price) {
            try {
                if(!confirm(`Confermi il noleggio per ${price} AVAX?`)) return;
                const tx = await contract.rentBook(id, { value: ethers.parseEther(price) });
                alert("Transazione inviata. Attendi la conferma...");
                await tx.wait();
                alert("Libro noleggiato con successo!");
                // Ricarica la vista attuale (o spostati sui noleggi)
                refreshCatalog(); 
            } catch(e) { alert("Errore: " + e.message); }
        }
        
        async function removeBook(id) {
            try {
                if(!confirm("Vuoi rimuovere questo libro dal mercato?")) return;
                const tx = await contract.removeBook(id);
                await tx.wait();
                alert("Libro rimosso.");
                refreshUploads();
            } catch(e) { alert("Errore: " + e.message); }
        }

    </script>
</body>
</html>